<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1DA1F2">
  <link rel="manifest" href="/manifest.json">
  <title>Forge</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #000000 0%, #15202B 100%);
      min-height: 100vh;
      color: #E7E9EA;
      transition: all 0.3s ease-in-out;
      overflow-x: hidden;
    }
    .light-mode {
      background: linear-gradient(135deg, #F5F7FA 0%, #E1E8ED 100%);
      color: #1C2526;
    }
    header {
      background: #1DA1F2;
      padding: 15px 25px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .container {
      max-width: 600px;
      margin: 20px auto;
      padding: 0 10px;
    }
    .card {
      background: #192734;
      border-radius: 15px;
      padding: 20px;
      margin: 15px 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .light-card {
      background: #FFFFFF;
      color: #1C2526;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
    }
    .hidden { display: none; }
    #themeToggle { cursor: pointer; font-size: 1.5em; }
    button {
      background: #1DA1F2;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
      font-weight: 700;
    }
    button:hover {
      background: #1991DA;
      transform: scale(1.05);
    }
    input {
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #3A4A5A;
      border-radius: 20px;
      width: 100%;
      max-width: 300px;
      font-size: 1em;
      background: #1E2A3D;
      color: #E7E9EA;
      transition: border-color 0.3s ease;
    }
    input:focus {
      border-color: #1DA1F2;
      outline: none;
    }
    canvas { max-width: 100%; height: auto; }
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .animated { animation: slideIn 0.5s ease-out; }
    @media (max-width: 600px) {
      .card { margin: 10px; padding: 15px; }
      header { padding: 10px; }
      input { max-width: 100%; }
      button { width: 100%; margin: 5px 0; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>Forge</h1>
    <span id="themeToggle">‚òÄÔ∏è</span>
  </header>
  <div class="container">
    <div id="login" class="card animated">
      <input type="email" id="email" placeholder="Email"><br>
      <input type="password" id="password" placeholder="Password"><br>
      <button onclick="login()">Login</button>
      <button onclick="signup()">Signup</button>
    </div>
    <div id="dashboard" class="hidden">
      <h2>Gig Feed</h2>
      <div id="gigFeed"></div>
      <button id="loadMore" class="animated">Load More</button>
      <h2>WoW Leaderboard</h2>
      <div id="leaderboard"></div>
      <h2>Saving Goals</h2>
      <canvas id="goalsChart"></canvas>
      <h2>Daily Check-In</h2>
      <input type="text" id="mood" placeholder="Mood">
      <input type="number" id="spend" placeholder="Spend">
      <button onclick="checkIn()" class="animated">Submit</button>
      <h2>Forge Oracle</h2>
      <input type="number" id="oracleAmount" placeholder="Amount">
      <button onclick="simulate()" class="animated">Simulate</button>
      <p id="oracleResult"></p>
      <h2>Referral Dashboard</h2>
      <div id="referrals"></div>
      <button onclick="shareReferral()" class="animated">Share Referral</button>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof supabase === 'undefined') {
        console.error('Supabase library not loaded. Check internet connection.');
        return;
      }
      const supabase = supabase.createClient('https://zpableyplrxvgmdovnqq.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwYWJsZXlwbHJ4dmdtZG92bnFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwOTcyNzEsImV4cCI6MjA3NDY3MzI3MX0.ncG3ZPwUz4NG5Qf0IUmB8fRV6h5OMcl2SWrtEvC4SE0');

      let user = null;
      let offset = 0;
      let isDark = true;

      // Theme Toggle (X/Robinhood-style light/dark switch)
      document.getElementById('themeToggle').addEventListener('click', () => {
        isDark = !isDark;
        document.body.classList.toggle('light-mode', !isDark);
        document.body.classList.toggle('dark-mode', isDark);
        document.querySelectorAll('.card').forEach(card => {
          card.classList.toggle('light-card', !isDark);
          card.classList.toggle('dark-card', isDark);
        });
        document.getElementById('themeToggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      });

      // Login Function
      async function login() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) console.error('Login error:', error.message); else {
          user = data.user;
          document.getElementById('login').classList.add('hidden');
          document.getElementById('dashboard').classList.remove('hidden');
          loadData();
          loadLeaderboard();
          loadReferrals();
        }
      }

      // Signup Function
      async function signup() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) console.error('Signup error:', error.message); else alert('Check email to verify account!');
      }

      // Load Gig Feed
      async function loadData() {
        const { data, error } = await supabase.from('gig_tips').select('*').range(offset, offset + 4);
        if (error) console.error('Feed error:', error); else {
          const feed = document.getElementById('gigFeed');
          data.forEach(tip => {
            const card = document.createElement('div');
            card.className = 'card animated';
            card.innerHTML = `<h3>${tip.title}</h3><p>${tip.content}</p>`;
            feed.appendChild(card);
          });
          offset += 5;
        }
      }

      document.getElementById('loadMore').addEventListener('click', loadData);

      // Realtime Leaderboard
      supabase
        .channel('forge-leaderboards')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'leaderboards' }, (payload) => {
          loadLeaderboard();
        })
        .subscribe();

      async function loadLeaderboard() {
        const { data, error } = await supabase.from('leaderboards').select('*').order('rank');
        if (error) console.error('Leaderboard error:', error); else {
          const board = document.getElementById('leaderboard');
          board.innerHTML = '<table><tr><th>Rank</th><th>User</th><th>Points</th></tr>';
          data.forEach(row => {
            board.innerHTML += `<tr><td>${row.rank}</td><td>${row.user_name}</td><td style="color:#00AA6C">${row.points}</td></tr>`;
          });
          board.innerHTML += '</table>';
        }
      }

      // Saving Goals (Static Chart)
      new Chart(document.getElementById('goalsChart'), {
        type: 'doughnut',
        data: { labels: ['Emergency', 'Invest'], datasets: [{ data: [3000, 1500], backgroundColor: ['#00AA6C', '#A855F7'] }] }
      });

      // Daily Check-In
      async function checkIn() {
        const mood = document.getElementById('mood').value;
        const spend = document.getElementById('spend').value;
        const { error } = await supabase.from('checkins').insert({ mood, spend, user_id: user.id });
        if (error) console.error('Check-in error:', error.message); else alert('Check-in saved!');
      }

      // Forge Oracle
      function simulate() {
        const amount = document.getElementById('oracleAmount').value;
        document.getElementById('oracleResult').innerHTML = `If save $${amount}: Retire at 45! Path: üìà Invest ‚Üí üèñÔ∏è Freedom`;
        document.getElementById('oracleResult').style.background = 'linear-gradient(to right, #00AA6C, #A855F7)';
        document.getElementById('oracleResult').style.padding = '10px';
        document.getElementById('oracleResult').style.borderRadius = '20px';
      }

      // Referral Dashboard (Realtime)
      supabase
        .channel('forge-referrals')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'referrals' }, (payload) => {
          loadReferrals();
        })
        .subscribe();

      async function loadReferrals() {
        const { data, error } = await supabase.from('referrals').select('*').eq('referrer_id', user.id);
        if (error) console.error('Referral error:', error); else {
          const refs = document.getElementById('referrals');
          refs.innerHTML = data.map(r => `<div class="card animated">${r.level}: ${r.user_email} - $<span style="color:#00AA6C">${r.reward}</span></div>`).join('');
        }
      }

      function shareReferral() {
        const link = `https://yourdomain.com/join/${user.id}`;
        navigator.clipboard.writeText(link);
        alert('Referral link copied: ' + link);
      }

      // Load initial data
      if (user) {
        loadData();
        loadLeaderboard();
        loadReferrals();
      }
    });
  </script>
</body>
</html>